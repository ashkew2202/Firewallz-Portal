<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Receipt â€” {{ transaction.ref_no|default:"Receipt" }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
            --brand:#0a58ca;
            --muted:#6b7280;
            --paper-white:#ffffff;
            --accent:#f3f4f6;
            --border:#e6e9ef;
            font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #111827;
        }
        body {
            margin: 0;
            background: var(--accent);
            padding: 24px;
        }
        .receipt {
            max-width: 820px;
            margin: 0 auto;
            background: var(--paper-white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 28px;
            box-shadow: 0 6px 22px rgba(12, 20, 40, 0.06);
        }
        header {
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap: 16px;
            margin-bottom: 18px;
        }
        .brand {
            display:flex;
            gap:12px;
            align-items:center;
        }
        .brand .logo {
            width:56px;
            height:56px;
            background:var(--brand);
            border-radius:8px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-weight:700;
            font-size:20px;
        }
        h1 { margin:0; font-size:20px; }
        .meta { text-align:right; color:var(--muted); font-size:13px; }
        .meta .ref { font-weight:600; color:var(--brand); font-size:14px; }

        .section { display:flex; gap:18px; margin:18px 0; }
        .box {
            flex:1;
            border:1px dashed var(--border);
            padding:12px;
            border-radius:6px;
            background:#fff;
        }
        .box h3 { margin:0 0 6px 0; font-size:13px; color:var(--muted); }
        .box p { margin:0; font-size:15px; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:12px;
        }
        table thead th {
            text-align:left;
            font-size:13px;
            color:var(--muted);
            padding:10px 8px;
            border-bottom:1px solid var(--border);
        }
        table tbody td {
            padding:12px 8px;
            vertical-align:top;
            font-size:14px;
            border-bottom:1px solid #f3f4f6;
        }
        .right { text-align:right; }
        .totals {
            margin-top:14px;
            display:flex;
            justify-content:flex-end;
        }
        .totals .inner {
            width:320px;
            background:linear-gradient(180deg,#fff, #fbfdff);
            padding:10px;
            border:1px solid var(--border);
            border-radius:6px;
        }
        .totals .row { display:flex; justify-content:space-between; padding:6px 0; color:#111827; }
        .totals .row .label { color:var(--muted); }

        .actions {
            margin-top:18px;
            display:flex;
            gap:8px;
            justify-content:flex-end;
        }
        .btn {
            display:inline-block;
            padding:10px 14px;
            border-radius:6px;
            border:1px solid transparent;
            cursor:pointer;
            background:var(--brand);
            color:white;
            font-weight:600;
            font-size:14px;
            text-decoration:none;
        }
        .btn.secondary { background:#fff; color:var(--brand); border-color:var(--border); }
        .small { font-size:13px; color:var(--muted); }

        @media print{
            body { padding:0; background:white; }
            .actions, .back-link { display:none !important; }
            .receipt { box-shadow:none; border: none; border-radius:0; margin:0; padding:12mm; }
            @page { size: A4; margin: 10mm; }
        }
    </style>
</head>
<body>
    <div class="receipt" id="receipt">
        <header>
            <div class="brand">
                <div class="logo">FZ</div>
                <div>
                    <h1>Firewallz Portal</h1>
                    <div class="small">Official Receipt</div>
                </div>
            </div>
            <div class="meta">
                <div class="ref">Ref: {{ transaction.ref_no|default:"N/A" }}</div>
                <div class="small">Date: {{ transaction.created_at|date:"N j, Y, P" }}</div>
                <div class="small">Status: {{ transaction.status|default:"PENDING" }}</div>
            </div>
        </header>

        <div class="section">
            <div class="box">
                <h3>Paid By</h3>
                <p><strong>{{ transaction.paid_by.name|default:"-" }}</strong></p>
                <p class="small">{{ transaction.paid_by.email|default:"" }}</p>
                {% if transaction.paid_by.address %}
                <p class="small">{{ transaction.paid_by.address }}</p>
                {% endif %}
            </div>

            <div class="box">
                <h3>Paid To</h3>
                <p><strong>{{ transaction.payee_name|default:"PCR" }}</strong></p>
                <p class="small">{{ transaction.payee_email|default:"support@pcr.example" }}</p>
            </div>
        </div>

        <section>
            <table>
                <thead>
                    <tr>
                        <th style="width:56%;">Description</th>
                        <th style="width:12%;">Qty</th>
                        <th style="width:16%;" class="right">Unit</th>
                        <th style="width:16%;" class="right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4">
                            <div style="padding:12px 0;" class="small">No line items provided. Showing transaction-level summary below.</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="totals">
                <div class="inner">
                    <div class="row">
                        <div class="label">Subtotal</div>
                        <div class="value">{{ transaction.subtotal|default:transaction.amount|floatformat:2 }}</div>
                    </div>
                    <div class="row">
                        <div class="label">Tax</div>
                        <div class="value">{{ transaction.tax|default:"0.00"|floatformat:2 }}</div>
                    </div>
                    <div class="row" style="font-weight:700; border-top:1px solid var(--border); padding-top:10px;">
                        <div class="label">Total ({{ transaction.currency|default:"Rupees" }})</div>
                        <div class="value">{{ transaction.amount|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
        </section>

        {% if transaction.notes %}
            <div style="margin-top:14px; color:var(--muted);">
                <strong>Notes</strong>
                <div class="small">{{ transaction.notes }}</div>
            </div>

            <script>
                // Prevent the automatic programmatic download from stealing focus / redirecting
                // Blocks non-user-initiated clicks on the hidden download button.
                (function(){
                    try {
                        var dl = document.getElementById('downloadBtn');
                        if (!dl) return;

                        dl.addEventListener('click', function(e){
                            // programmatic clicks have isTrusted === false; only allow real user clicks
                            if (!e.isTrusted) {
                                e.preventDefault();
                                e.stopImmediatePropagation();
                            }
                        }, true);
                    } catch(e){}
                })();
            </script>
        {% endif %}

        <div class="actions">
            <a href="javascript:void(0)" id="printBtn" class="btn">Print / Save as PDF</a>
            <!-- keep downloadBtn hidden so the existing download handler can be invoked programmatically -->
            <a href="javascript:void(0)" id="downloadBtn" class="btn secondary" style="display:none">Download HTML</a>
        </div>
    </div>

    <script>
        // auto-trigger the download to save the receipt file immediately
        (function(){
            try {
                // allow the outer script to attach the click handler first
                setTimeout(function(){
                    var dl = document.getElementById('downloadBtn');
                    if (dl) dl.click();
                }, 300);
            } catch(e){}
        })();
    </script>

    <script>
        (function(){
            var printBtn = document.getElementById('printBtn');
            var downloadBtn = document.getElementById('downloadBtn');

            printBtn.addEventListener('click', function(){
                window.print();
            });

            downloadBtn.addEventListener('click', function(){
                // Download the receipt HTML as a .html file (simple client-side approach)
                var content = document.getElementById('receipt').outerHTML;
                var blob = new Blob(['<!doctype html><html>'+document.head.outerHTML+'<body>'+content+'</body></html>'], {type: 'text/html'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'receipt_{{ transaction.ref_no|default:"receipt" }}.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // auto-print if query param print=1 provided
            try {
                var params = new URLSearchParams(window.location.search);
                if (params.get('print') === '1') {
                    setTimeout(function(){ window.print(); }, 250);
                }
            } catch(e){}
        })();
    </script>
</body>
</html></div></td>